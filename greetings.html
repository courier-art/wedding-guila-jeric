<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wish Greetings - Guila & Jeric</title>
    
    <!-- EXTERNAL RESOURCES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- STYLESHEETS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- PAGE-SPECIFIC STYLES -->
    <style>
        /* Additional styles for greetings page */
        .message-form-container {
            max-width: 600px;
            margin: 3rem auto;
            padding: 3rem;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--gray-medium);
        }
        
        .character-count {
            text-align: right;
            font-size: 0.9rem;
            color: var(--gray-dark);
            margin-top: 0.5rem;
        }
        
        .message-prompt {
            text-align: center;
            font-style: italic;
            color: var(--gray-dark);
            margin-bottom: 2rem;
        }
        
        .messages-intro {
            text-align: center;
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* UPDATED: Messages container for bubble system */
        .messages-grid {
            position: relative;
            min-height: 700px;
            overflow: hidden;
            margin: 4rem 0;
            padding: 20px;
            background: linear-gradient(to bottom, #dfdfdf,#f8f8f8);
            border-radius: 15px;
            border: 1px solid rgba(224, 224, 224, 0.3);
            width: 100%;
        }
        
        /* Bubble size classes */
        .bubble-xs {
            max-width: 150px;
            min-width: 90px;
            min-height: 50px;
            font-size: 0.7em;
        }
        
        .bubble-small {
            max-width: 180px;
            min-width: 120px;
            min-height: 70px;
            font-size: 0.8em;
        }
        
        .bubble-medium {
            max-width: 220px;
            min-width: 150px;
            min-height: 90px;
            font-size: 0.9em;
        }
        
        .bubble-large {
            max-width: 280px;
            min-width: 180px;
            min-height: 110px;
            font-size: 1em;
        }
        
        /* Message card styling for bubbles */
        .message-card {
            position: absolute !important;
            padding: 15px !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            border-radius: 15px !important;
            background: white !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease !important;
            z-index: 1;
            animation: fadeIn 0.8s ease forwards;
            word-wrap: break-word;
            overflow: hidden;
            max-width: 280px;
        }
        
        /* Stop animation on hover */
        .message-card:hover {
            transform: scale(1.05) !important;
            z-index: 10 !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
        }
        
        /* Message content styling */
        .message-author {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .message-date {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .message-content {
            line-height: 1.4;
            font-size: 0.9rem;
            color: #444;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Loading and no messages states */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray-dark);
            font-style: italic;
        }
        
        .no-messages {
            text-align: center;
            padding: 3rem;
            color: var(--gray-dark);
            font-style: italic;
        }
        
        /* Alert styles */
        .custom-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 2rem;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .custom-alert.success {
            background: #28a745;
            color: white;
        }
        
        .custom-alert.error {
            background: #dc3545;
            color: white;
        }
        
        /* NEW: Adjust for mobile */
        @media (max-width: 768px) {
            .messages-grid {
                min-height: 600px;
                padding: 10px !important;
            }
            
            /* .message-card {
                position: relative !important;
                margin-bottom: 1rem;
                max-width: 100% !important;
                width: 100% !important;
                left: 0 !important;
                top: auto !important;
            } */
            
            /* On mobile, stack messages normally */
            .messages-grid {
                /* display: grid; */
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">G&J</a>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="story.html">Our Story</a></li>
                <li><a href="bigday.html">The Big Day</a></li>
                <li><a href="nuptials.html">Nuptials</a></li>
                <li><a href="greetings.html" class="active">Wish Greetings</a></li>
                <li><a href="rsvp.html">RSVP</a></li>
            </ul>
        </div>
    </nav>

    <section class="hero">
        <div class="container">
            <div class="hero-content page-transition">
                <h1>Wish Greetings</h1>
                <p class="subtitle">Leave a message for the newlyweds</p>
                
                <!-- INTRODUCTION -->
                <div class="messages-intro">
                    <p>Your words of love, encouragement, and wisdom mean the world to us. Please share your thoughts, memories, or well wishes that we can cherish forever.</p>
                    <p style="margin-top: 1rem;"><em>Messages will be displayed below and saved in our wedding memory book.</em></p>
                </div>
                
                <!-- MESSAGE FORM -->
                <div class="message-form-container">
                    <h2 style="text-align: center; margin-bottom: 2rem;">Send Your Wishes</h2>
                    
                    <form id="messageForm">
                        <!-- NAME FIELD -->
                        <div class="form-group">
                            <label class="form-label" for="name">Your Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   placeholder="Enter your full name">
                        </div>
                        
                        <!-- RELATIONSHIP FIELD (Optional) -->
                        <div class="form-group">
                            <label class="form-label" for="relationship">Your Relationship to the Couple</label>
                            <input type="text" class="form-control" id="relationship" name="relationship" 
                                   placeholder="E.g., Friend, Family, Colleague, etc.">
                        </div>
                        
                        <!-- MESSAGE FIELD -->
                        <div class="form-group">
                            <label class="form-label" for="message">Your Message *</label>
                            <textarea class="form-control" id="message" name="message" rows="6" 
                                      required placeholder="Share your thoughts, memories, or well wishes..."
                                      maxlength="500"></textarea>
                            <div class="character-count">
                                <span id="charCount">0</span>/500 characters
                            </div>
                        </div>
                        
                        <!-- SUBMIT BUTTON -->
                        <div style="text-align: center; margin-top: 2rem;">
                            <button type="submit" class="btn">
                                <i class="fas fa-paper-plane"></i> Send Message
                            </button>
                        </div>
                        
                        <!-- PRIVACY NOTE -->
                        <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: var(--gray-dark);">
                            * Required fields. Your message will be visible to other guests.
                        </p>
                    </form>
                </div>
                
                <!-- MESSAGES GRID -->
                <h2 style="text-align: center; margin-top: 4rem;">Messages from Friends & Family</h2>
                <p class="message-prompt">Hover over any message to pause it and read</p>
                
                <div class="messages-grid" id="floatingMessages">
                    <div class="loading" id="loadingMessages">
                        <i class="fas fa-spinner fa-spin"></i> Loading messages...
                    </div>
                    <!-- Messages will be loaded dynamically as bubbles -->
                </div>
                
                <!-- INSTRUCTIONS FOR GUESTS -->
                <div style="background: var(--gradient-light); padding: 2rem; border-radius: 10px; margin-top: 3rem; text-align: center;">
                    <h3>Tips for Your Message</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                        <div>
                            <i class="fas fa-heart" style="color: var(--black); font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p><strong>Share a Memory</strong><br>A special moment you shared with the couple</p>
                        </div>
                        <div>
                            <i class="fas fa-lightbulb" style="color: var(--black); font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p><strong>Offer Advice</strong><br>Wisdom from your own marriage or relationships</p>
                        </div>
                        <div>
                            <i class="fas fa-laugh" style="color: var(--black); font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p><strong>Tell a Funny Story</strong><br>Share a lighthearted moment or inside joke</p>
                        </div>
                        <div>
                            <i class="fas fa-pray" style="color: var(--black); font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                            <p><strong>Send Blessings</strong><br>Your prayers and well-wishes for their future</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Guila & Jeric</h3>
                    <p>September 5, 2026</p>
                    <p>Kawit & Noveleta, Cavite</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="story.html">Our Love Story</a></li>
                        <li><a href="bigday.html">Event Details</a></li>
                        <li><a href="nuptials.html">Wedding Party</a></li>
                        <li><a href="rsvp.html">RSVP</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>For any questions, please contact:</p>
                    <p>Guila: +63 912 345 6789</p>
                    <p>Jeric: +63 987 654 3210</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2026 Guila & Jeric Wedding. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // ============================================
        // GLOBAL VARIABLES AND CONFIGURATION
        // ============================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUCFh3v2Wpel24P2zPtMRMsONpJzrKSz4SvN8s_246KQ1hyg2rtGblUDUJ-pZkE46Keg/exec';
        const MAX_BUBBLES = 12; // Reduced for better spacing
        const MAX_MESSAGES = 100; // Store more messages for looping
        const BUBBLE_SPEED_MIN = 0.5;
        const BUBBLE_SPEED_MAX = 1.2;
        const BUBBLE_REFRESH_INTERVAL = 3000; // 3 seconds
        const BUBBLE_RESPAWN_DELAY = 2000; // 2 seconds delay before respawning

        let allMessages = [];
        let displayedMessages = new Set();
        let activeBubbles = [];
        let animationFrameId = null;
        let lastFetchTime = 0;
        let colorIndex = 0;
        let isLooping = true;
        let messageQueue = []; // Queue for messages waiting to be displayed

        // Color palette for bubbles (wedding theme colors)
        const BUBBLE_COLORS = [
            '#f8f0fc', '#f3e8ff', '#e9d5ff', '#d8b4fe', '#c084fc',
            '#fce7f3', '#fbcfe8', '#f9a8d4', '#f472b6', '#db2777',
            '#fef3c7', '#fde68a', '#fcd34d', '#fbbf24', '#f59e0b'
        ];
        
        // ============================================
        // CHARACTER COUNT FOR MESSAGE TEXTAREA
        // ============================================
        const messageTextarea = document.getElementById('message');
        const charCount = document.getElementById('charCount');
        
        if (messageTextarea && charCount) {
            messageTextarea.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = length;
                
                if (length > 450) {
                    charCount.style.color = '#dc3545';
                } else if (length > 400) {
                    charCount.style.color = '#ffc107';
                } else {
                    charCount.style.color = '';
                }
            });
            
            charCount.textContent = messageTextarea.value.length;
        }
        
        // ============================================
        // ESCAPE HTML TO PREVENT XSS
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ============================================
        // FETCH MESSAGES FROM GOOGLE SHEETS
        // ============================================
        
        async function fetchMessages() {
            try {
                const now = Date.now();
                if (now - lastFetchTime < 5000 && allMessages.length > 0) return;
                lastFetchTime = now;

                const response = await fetch(`${SCRIPT_URL}?action=getData`);
                const result = await response.json();

                const loadingElement = document.getElementById('loadingMessages');
                if (loadingElement) loadingElement.style.display = 'none';

                if (result.success && result.data && result.data.length > 0) {
                    result.data.forEach(msg => {
                        const msgId = `${msg.name}-${msg.message}-${msg.timestamp}`;
                        
                        if (!displayedMessages.has(msgId)) {
                            const newMsg = {
                                name: msg.name || 'Anonymous',
                                relationship: msg.relationship || '',
                                message: msg.message || '',
                                timestamp: msg.timestamp || new Date().toISOString(),
                                id: msgId
                            };
                            
                            // 1. Add to the pool
                            allMessages.push(newMsg);
                            displayedMessages.add(msgId);
                            
                            // 2. IMMEDIATE DISPLAY: Create bubble right now for the new entry
                            const container = document.getElementById('floatingMessages');
                            createBubble(newMsg, container);
                        }
                    });

                    if (allMessages.length > MAX_MESSAGES) {
                        allMessages = allMessages.slice(-MAX_MESSAGES);
                    }
                }
            } catch (error) {
                console.error('Error fetching:', error);
            }
        }
        
        // ============================================
        // CREATE AND MANAGE BUBBLES
        // ============================================
        function createBubble(messageData, container) {
            const containerRect = container.getBoundingClientRect();
            const bubble = document.createElement('div');
            
            // Determine bubble size based on message length
            const messageLength = messageData.message.length;
            let sizeClass = 'bubble-small';
            if (messageLength < 50) sizeClass = 'bubble-xs';
            else if (messageLength < 150) sizeClass = 'bubble-small';
            else if (messageLength < 300) sizeClass = 'bubble-medium';
            else sizeClass = 'bubble-large';
            
            bubble.className = `message-card ${sizeClass}`;
            
            // Get next color in sequence
            const color = BUBBLE_COLORS[colorIndex % BUBBLE_COLORS.length];
            colorIndex++;
            
            // Apply styling
            bubble.style.backgroundColor = color;
            
            // Format date
            let displayDate = 'Recently';
            if (messageData.timestamp) {
                const date = new Date(messageData.timestamp);
                if (!isNaN(date)) {
                    displayDate = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }
            
            // Create message content
            bubble.innerHTML = `
                <div class="message-author">${escapeHtml(messageData.name)}</div>
                <div class="message-date">${displayDate}${messageData.relationship ? ` â€¢ ${escapeHtml(messageData.relationship)}` : ''}</div>
                <div class="message-content">${escapeHtml(messageData.message)}</div>
            `;
            
            // Add to container first to measure dimensions
            container.appendChild(bubble);
            
            // Find position at the bottom
            const position = findPositionForBubble(bubble, containerRect, activeBubbles);
            
            // Set initial position at the bottom
            bubble.style.left = `${position.x}px`;
            bubble.style.top = `${containerRect.height}px`; // Start at bottom
            
            const bubbleWidth = bubble.offsetWidth;
            const bubbleHeight = bubble.offsetHeight;
            
            // Store bubble reference
            const bubbleData = {
                element: bubble,
                x: position.x,
                y: parseInt(bubble.style.top),
                width: bubbleWidth,
                height: bubbleHeight,
                speed: BUBBLE_SPEED_MIN + Math.random() * (BUBBLE_SPEED_MAX - BUBBLE_SPEED_MIN),
                isMoving: true,
                isHovered: false,
                messageId: messageData.id,
                id: Date.now() + Math.random()
            };
            
            activeBubbles.push(bubbleData);
            
            // Add hover effect
            bubble.addEventListener('mouseenter', () => {
                bubbleData.isHovered = true;
                bubble.style.zIndex = '20';
                bubble.style.transform = 'scale(1.05)';
                bubble.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            bubble.addEventListener('mouseleave', () => {
                bubbleData.isHovered = false;
                bubble.style.zIndex = '1';
                bubble.style.transform = 'scale(1)';
                bubble.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
            });
            
            return bubbleData;
        }
        
        // ============================================
        // FIND POSITION FOR NEW BUBBLE (AVOID COLLISIONS)
        // ============================================
        function findPositionForBubble(bubble, containerRect, existingBubbles) {
            const bubbleWidth = bubble.offsetWidth;
            const maxX = containerRect.width - bubbleWidth;
            
            // Try to find a position with minimal overlap
            let bestX = Math.floor(Math.random() * maxX);
            let minOverlap = Infinity;
            
            // Test several X positions
            for (let i = 0; i < 10; i++) {
                const testX = Math.floor(Math.random() * maxX);
                let totalOverlap = 0;
                
                for (const activeBubble of existingBubbles) {
                    // Only check bubbles near the bottom
                    if (activeBubble.y > containerRect.height - 100) {
                        const overlap = calculateOverlap(
                            testX, containerRect.height, bubbleWidth, bubble.offsetHeight,
                            activeBubble.x, activeBubble.y, activeBubble.width, activeBubble.height
                        );
                        totalOverlap += overlap;
                    }
                }
                
                if (totalOverlap < minOverlap) {
                    minOverlap = totalOverlap;
                    bestX = testX;
                }
            }
            
            return {
                x: bestX,
                y: containerRect.height
            };
        }
        
        // ============================================
        // CALCULATE OVERLAP AREA
        // ============================================
        function calculateOverlap(x1, y1, w1, h1, x2, y2, w2, h2) {
            const xOverlap = Math.max(0, Math.min(x1 + w1, x2 + w2) - Math.max(x1, x2));
            const yOverlap = Math.max(0, Math.min(y1 + h1, y2 + h2) - Math.max(y1, y2));
            return xOverlap * yOverlap;
        }
        
        // ============================================
        // CHECK IF BUBBLE CAN MOVE (NO COLLISIONS)
        // ============================================
        function canBubbleMove(bubble) {
            for (const otherBubble of activeBubbles) {
                if (bubble.id === otherBubble.id) continue;
                
                // Only check bubbles that are above this bubble
                if (otherBubble.y < bubble.y) {
                    if (doRectanglesOverlap(
                        bubble.x, bubble.y - bubble.speed, bubble.width, bubble.height,
                        otherBubble.x, otherBubble.y, otherBubble.width, otherBubble.height,
                        5 // padding
                    )) {
                        return false;
                    }
                }
            }
            return true;
        }
        
        // ============================================
        // CHECK RECTANGLE OVERLAP
        // ============================================
        function doRectanglesOverlap(x1, y1, w1, h1, x2, y2, w2, h2, padding = 5) {
            return !(
                x1 + w1 <= x2 + padding ||
                x2 + w2 <= x1 + padding ||
                y1 + h1 <= y2 + padding ||
                y2 + h2 <= y1 + padding
            );
        }
        
        // ============================================
        // ADD BUBBLE IF CONDITIONS ARE RIGHT
        // ============================================
        function addBubble() {
            const container = document.getElementById('floatingMessages');
            if (!container || allMessages.length === 0 || activeBubbles.length >= MAX_BUBBLES) {
                return;
            }

            // RANDOM LOOP LOGIC: Pick any message from the entire history
            const randomIndex = Math.floor(Math.random() * allMessages.length);
            const message = allMessages[randomIndex];

            createBubble(message, container);
        }

        // Special function to display new entries immediately
        function triggerImmediateBubble(messageData) {
            const container = document.getElementById('floatingMessages');
            // Even if at MAX_BUBBLES, we force the new one in for the "immediate" effect
            createBubble(messageData, container);
        }
        
        // ============================================
        // MAIN ANIMATION LOOP (MOVES BUBBLES UP)
        // ============================================
        function animateBubbles() {
            const container = document.getElementById('floatingMessages');
            if (!container) return;
            
            const containerRect = container.getBoundingClientRect();
            
            // Update each bubble's position
            for (let i = 0; i < activeBubbles.length; i++) {
                const bubble = activeBubbles[i];
                
                // Skip if bubble is hovered
                if (bubble.isHovered) continue;
                
                // Check if bubble reached the top (remove if it has)
                if (bubble.y + bubble.height < 0) {
                    // Remove bubble
                    bubble.element.remove();
                    activeBubbles.splice(i, 1);
                    i--;
                    continue;
                }
                
                // Check if bubble can move (no collisions)
                const canMove = canBubbleMove(bubble);
                
                if (canMove && !bubble.isMoving) {
                    // Resume movement if it was previously stopped
                    bubble.isMoving = true;
                } else if (!canMove && bubble.isMoving) {
                    // Stop movement if there's a collision
                    bubble.isMoving = false;
                }
                
                // Move bubble if it's allowed to move
                if (bubble.isMoving) {
                    bubble.y -= bubble.speed;
                    bubble.element.style.top = `${bubble.y}px`;
                }
            }
            
            // Try to add a new bubble if we have space
            if (activeBubbles.length < MAX_BUBBLES && allMessages.length > 0) {
                addBubble();
            }
            
            // Continue animation
            animationFrameId = requestAnimationFrame(animateBubbles);
        }
        
        // ============================================
        // SHOW ALERT MESSAGE
        // ============================================
        function showAlert(message, type = 'success') {
            // Remove existing alerts to prevent stacking
            const existingAlerts = document.querySelectorAll('.custom-alert');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert ${type}`;
            
            // ADD THIS PART: Set the content inside the alert
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            alertDiv.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Remove after 3 seconds
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        document.body.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }
        
        // ============================================
        // MESSAGE FORM SUBMISSION TO GOOGLE SHEETS
        // ============================================
        const messageForm = document.getElementById('messageForm');
        if (messageForm) {
            messageForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const name = formData.get('name').trim();
                const relationship = formData.get('relationship').trim();
                const message = formData.get('message').trim();
                
                // Validation
                if (!name || !message) {
                    showAlert('Please fill in all required fields.', 'error');
                    return;
                }
                
                if (message.length < 10) {
                    showAlert('Please write a message of at least 10 characters.', 'error');
                    return;
                }
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                submitBtn.disabled = true;
                
                try {
                    // Prepare data for Google Sheets
                    const timestamp = new Date().toISOString();
                    const data = {
                        name: name,
                        relationship: relationship,
                        message: message,
                        timestamp: timestamp
                    };
                    
                    // Send to Google Sheets
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Show success message
                        showAlert('Message sent successfully!', 'success');
                        
                        // Add to local messages array
                        const msgId = `${name}-${message}-${timestamp}`;
                        allMessages.unshift({
                            name: name,
                            relationship: relationship,
                            message: message,
                            timestamp: timestamp,
                            id: msgId,
                            isNew: true
                        });
                        displayedMessages.add(msgId);
                        
                        // Update display if we have space for more bubbles
                        if (activeBubbles.length < MAX_BUBBLES) {
                            addBubble();
                        }
                        
                        // Reset form
                        this.reset();
                        charCount.textContent = '0';
                        
                    } else {
                        throw new Error(result.message || 'Failed to send message');
                    }
                    
                } catch (error) {
                    console.error('Error submitting message:', error);
                    showAlert('Failed to send message. Please try again.', 'error');
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }
        
        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Load existing messages
            fetchMessages();
            
            // Start animation loop
            animateBubbles();
            
            // Refresh messages every 5 seconds
            setInterval(fetchMessages, BUBBLE_REFRESH_INTERVAL);
            
            // Handle window resize
            window.addEventListener('resize', function() {
                // Reposition bubbles on resize
                const container = document.getElementById('floatingMessages');
                if (container) {
                    const containerRect = container.getBoundingClientRect();
                    activeBubbles.forEach(bubble => {
                        // Keep bubbles within container bounds
                        if (bubble.x + bubble.width > containerRect.width) {
                            bubble.x = containerRect.width - bubble.width;
                            bubble.element.style.left = `${bubble.x}px`;
                        }
                        if (bubble.y + bubble.height > containerRect.height) {
                            bubble.y = containerRect.height - bubble.height;
                            bubble.element.style.top = `${bubble.y}px`;
                        }
                    });
                }
            });
        });
        
        // ============================================
        // CLEAN UP ON PAGE UNLOAD
        // ============================================
        window.addEventListener('beforeunload', function() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        });
    </script>
</body>
</html>